<table class="display responsive no-wrap" id="worker_table" width="100%">
  <thead>
    <tr>
      <th>Name</th>
      <th>Mobile</th>
      <th>Worked</th>
      <th>Contacted</th>
      <th>Last contacted</th>
      <th style="display: none">Interested in working with</th>
      <th>Profile</th>
    </tr>
  </thead>
  <!-- The footer is used to build the activities filter -->
  <tfoot>
    <tr>
      <th>Name</th>
      <th>Mobile</th>
      <th>Worked</th>
      <th>Contacted</th>
      <th>Last contacted</th>
      <th id="activities-footer" style="display: none">Interested in working with</th>
      <th>Profile</th>
    </tr>
  </tfoot>
  <tbody>
    <% @members.each do |member| %>
    <tr>
      <td><%= member.name %></td>
      <td>
        <a href="tel:<%= member.mobile %>">
          <button type="button" class="btn btn-default" aria-label="Left Align">
            <span class="glyphicon glyphicon-earphone" aria-hidden="true"></span>
            <%= member.mobile %>
          </button>
        </a>
      </td>
      <td>
        <%= member.nbr_jobs %>
        <span data-toggle="modal" data-target=".bs-job-modal-sm" onclick="formActionValue(<%=member.id%>, 'jobs')" class="glyphicon glyphicon-plus clickable" aria-hidden="true"></span>
      </td>
      <td>
        <%= member.nbr_contacteds %>
        <span data-toggle="modal" data-target=".bs-contacted-modal-sm" onclick="formActionValue(<%=member.id%>, 'contacteds')" class="glyphicon glyphicon-plus clickable" aria-hidden="true"></span>
      </td>
      <td><%= member.last_contacted %></td>
      <td id="table-activity-column" style="display: none"><%= member.activities %> </td>
      <td>
        <%= link_to cooperative_member_path(@cooperative, member) do %>
        <button type="button" class="btn btn-default btn-default">
          <span class="glyphicon glyphicon-user" aria-hidden="true"></span> Profile
        </button>
        <% end %>
      </td>
    </tr>
    <% end %>
  </tbody>
</table>

<script text="text/javascript">
  // Jquery datatable code

  $( document ).ready(function() {
    $('#worker_table').DataTable( {
      responsive: true,
      retrieve: true,
      initComplete: function () {
        this.api().columns().every( function () {
          var column = this;
          // only create a filter for the column activities
          if($(column.footer())[0].id === "activities-footer"){
            var select = $('<select><option value="">Work with filter</option></select>')
              .css("margin-left", "10px")
              .css("float", "right")
              // .appendTo( $("#activities-filter-header").empty() )
              .insertBefore( $("#worker_table_filter") )
              .on( 'change', function () {
                var val = $.fn.dataTable.util.escapeRegex(
                  $(this).val()
                );
                // the standard filter function
                // column
                //   .search( val ? '^'+val+'$' : '', true, false )
                //   .draw();

                // adjusted filter function to fit worker list purpose
                column
                .search( val, true, false )
                .draw();
              } );

            var unique_activities = []
            column.data().unique().sort().each( function ( d, j ) {
              var activities = d.split("\, ")
              for (var i = 0; i < activities.length; i++) {
                // see if the activity option is already added
                if(unique_activities.indexOf(activities[i]) === -1 ){
                  unique_activities.push(activities[i])
                }
              }
            } );
            for (var i = 0; i < unique_activities.length; i++) {
              select.append( '<option value="'+unique_activities[i]+'">'+unique_activities[i]+'</option>' )
            }
          }
          $(column.footer()).empty()
        } );
      }
    } );
  });

</script>