<script text="text/javascript">

$('#worker_table').DataTable( {
  initComplete: function () {
    this.api().columns().every( function () {
      var column = this;
      // only create a filter for the column activities
      if($(column.footer())[0].textContent === "Activities"){
        var select = $('<select><option value=""></option></select>')
          .appendTo( $(column.footer()).empty() )
          .on( 'change', function () {
            var val = $.fn.dataTable.util.escapeRegex(
              $(this).val()
            );
            // the standard filter function
            // column
            //   .search( val ? '^'+val+'$' : '', true, false )
            //   .draw();

            // adjusted filter function to fit worker list purpose
            column
            .search( val, true, false )
            .draw();
          } );

        var unique_activities = []
        
        column.data().unique().sort().each( function ( d, j ) {
          var activities = d.split("\, ")
          for (var i = 0; i < activities.length; i++) {
            // see if the activity option is already added
            if(unique_activities.indexOf(activities[i]) === -1 ){
              unique_activities.push(activities[i])
            }
          }  
        } );
        for (var i = 0; i < unique_activities.length; i++) {
          select.append( '<option value="'+unique_activities[i]+'">'+unique_activities[i]+'</option>' )
        }
      } else{
        // clear away the datatable footer
        $(column.footer()).empty()
      }
    } );
  }
} );


</script>
<table class="display" id="worker_table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Mobile</th>
      <th>Worked</th>
      <th>Contacted</th>
      <th>Last contacted</th>
      <th>Activities</th>
    </tr>
  </thead>
  <tfoot>
    <tr>
      <th>Name</th>
      <th>Mobile</th>
      <th>Worked</th>
      <th>Contacted</th>
      <th>Last contacted</th>
      <th>Activities</th>
    </tr>
  </tfoot>
  <tbody>
    <% @members.each do |member| %>
    <tr class="worker_row">
      <td onclick="show_worker('<%= cooperative_member_path(@cooperative, member) %>')"><%= member.name %></td>
      <td onclick="show_worker('<%= cooperative_member_path(@cooperative, member) %>')"><%= member.mobile %></td>
      <td>
        <%= member.jobs.length %>
        <span data-toggle="modal" data-target=".bs-job-modal-sm" onclick="formActionValue(<%=member.id%>, 'jobs')" class="glyphicon glyphicon-plus clickable" aria-hidden="true"></span>
      </td>
      <td>
        <%= member.contacteds.length %>
        <span data-toggle="modal" data-target=".bs-contacted-modal-sm" onclick="formActionValue(<%=member.id%>, 'contacteds')" class="glyphicon glyphicon-plus clickable" aria-hidden="true"></span>
      </td>
      <% if member.contacteds.last.nil? %>
        <% last_contacted = "Never contacted" %>
      <% else %>
        <% last_contacted = member.contacteds.last.date %>
      <% end %>
      <td onclick="show_worker('<%= cooperative_member_path(@cooperative, member) %>')"><%= last_contacted %></td>
      <td onclick="show_worker('<%= cooperative_member_path(@cooperative, member) %>')"><%= member.activities %> </td>
    </tr>
    <% end %>
  </tbody>
</table>
